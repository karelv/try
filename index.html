<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="utf-8">
<title></title>
<meta name="description" content="">
<meta name="author" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="">
<link rel="shortcut icon" href="">
</head>
<body>

<h1>Web BLE sandbox</h1>

<h2>Scan devices</h2>

00090632-0000-0000-0000-000000090632

<br/>
<br/>
<br/>
<button id="bt_scan">scan</button>
<button id="bt_stop">stop</button>
<button id="bt_start">start</button>

<br><br>

<div id='log'></div>

<div id='meas'></div>

<!-- Place your content here -->

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.slim.min.js"></script>

<script type="text/javascript">


var my_characteristic;

$("#bt_scan").click(function () {
  console.log("clicked");

  // navigator.bluetooth.requestDevice({acceptAllDevices: true})
  // navigator.bluetooth.requestDevice({filters: [{ services: 
  //     ['device_information', 
  //      '49535343-fe7d-4ae5-8fa9-9fafd205e455', 
  //      '00090632-0000-0000-0000-000000090632'
  //     ]} ] })
  navigator.bluetooth.requestDevice({filters: [{ namePrefix: ['RN4871']}], optionalServices: ['00090632-0000-0000-0000-000000090632'] })
  .then(device => { 
    console.log('found!'); 
    console.log(device.name); 
    $('#log').append(device.name + '<br>')
    // Attempts to connect to remote GATT Server.
    return device.gatt.connect();
  })
  .then(server => {
    // Getting mlx90632 Service…
    console.log('get service');
    $('#log').append('get service<br>')
    return server.getPrimaryService('00090632-0000-0000-0000-000000090632');
  })
  .then(mlx90632_service => {
    console.log('get characteristic');
    $('#log').append('get characteristic<br>')
    // Getting RAM 3-8 Characteristic…
    return mlx90632_service.getCharacteristic('00090632-4003-000c-0000-000000090632');
  })
  .then(characteristic => characteristic.startNotifications())
  .then(characteristic => {
    my_characteristic = characteristic;
    characteristic.addEventListener('characteristicvaluechanged',
                                    handleNotifications);
      console.log('Notifications have been started.');
  })
  .catch(error => { 
    console.log(error);
    console.error(error); 
  });

});

function handleNotifications(event) {
  const value = event.target.value;
    console.log('value is ');
    console.log(value);
    $('#meas').html('values are: <br>');
    ram3 = value.getInt16(0)
    ram4 = value.getInt16(2)
    ram5 = value.getInt16(4)
    ram6 = value.getInt16(6)
    ram7 = value.getInt16(8)
    ram8 = value.getInt16(10)
    $('#meas').append('ram3: ' + ram3 + '<br>');
    $('#meas').append('ram4: ' + ram4 + '<br>');
    $('#meas').append('ram5: ' + ram5 + '<br>');
    $('#meas').append('ram6: ' + ram6 + '<br>');
    $('#meas').append('ram7: ' + ram7 + '<br>');
    $('#meas').append('ram8: ' + ram8 + '<br>');
}



$("#bt_stop").click(function () {
  if (my_characteristic) {
    my_characteristic.stopNotifications()
    .then(_ => {
      console.log('> Notifications stopped');
      my_characteristic.removeEventListener('characteristicvaluechanged',
          handleNotifications);
    })
    .catch(error => {
      console.log('Argh! ' + error);
    });
  }
});

$("#bt_start").click(function () {
  if (my_characteristic) {
    my_characteristic.startNotifications()
    .then(_ => {
      console.log('> Notifications started');
      my_characteristic.addEventListener('characteristicvaluechanged',
          handleNotifications);
    })
    .catch(error => {
      console.log('Argh! ' + error);
    });
  }
});

</script>


</body>
</html>
